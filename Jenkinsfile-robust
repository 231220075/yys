pipeline {
    agent any
    
    // å¦‚æœJenkinsä¸­æ²¡æœ‰é…ç½®Mavenå’ŒJDKå·¥å…·ï¼Œæ³¨é‡Šæ‰ä¸‹é¢çš„toolséƒ¨åˆ†
    tools {
        maven 'Maven-3.9.0'  // éœ€è¦åœ¨Jenkinsä¸­é…ç½®Mavenå·¥å…·
        jdk 'JDK-17'         // éœ€è¦åœ¨Jenkinsä¸­é…ç½®JDKå·¥å…·
    }
    
    environment {
        DOCKER_IMAGE = 'yys-app'
        DOCKER_TAG = "${BUILD_NUMBER}"
        K8S_NAMESPACE = 'default'
        MAVEN_OPTS = '-Dmaven.test.failure.ignore=false'
    }
    
    stages {
        stage('Environment Check') {
            steps {
                echo '=== ç¯å¢ƒæ£€æŸ¥ ==='
                script {
                    sh '''
                        echo "æ£€æŸ¥Javaç‰ˆæœ¬:"
                        java -version || echo "Java not found"
                        
                        echo "æ£€æŸ¥Mavenç‰ˆæœ¬:"
                        mvn -version || echo "Maven not found"
                        
                        echo "æ£€æŸ¥Dockerç‰ˆæœ¬:"
                        docker --version || echo "Docker not found"
                        
                        echo "æ£€æŸ¥kubectlç‰ˆæœ¬:"
                        kubectl version --client || echo "kubectl not found"
                        
                        echo "å½“å‰å·¥ä½œç›®å½•:"
                        pwd
                        
                        echo "é¡¹ç›®æ–‡ä»¶åˆ—è¡¨:"
                        ls -la
                    '''
                }
            }
        }
        
        stage('Checkout') {
            steps {
                checkout scm
            }
        }
        
        stage('Test') {
            steps {
                echo '=== è¿è¡Œå•å…ƒæµ‹è¯• ==='
                script {
                    try {
                        // ä½¿ç”¨Dockerå®¹å™¨è¿è¡ŒMavenï¼Œå¦‚æœæœ¬åœ°æ²¡æœ‰Maven
                        def mavenCommand = '''
                            if command -v mvn &> /dev/null; then
                                echo "ä½¿ç”¨æœ¬åœ°Maven..."
                                mvn clean test
                            else
                                echo "æœ¬åœ°Mavenæœªæ‰¾åˆ°ï¼Œä½¿ç”¨Dockerè¿è¡ŒMaven..."
                                docker run --rm -v "$PWD":/usr/src/app -v "$HOME/.m2":/root/.m2 -w /usr/src/app maven:3.9.4-openjdk-17 mvn clean test
                            fi
                        '''
                        sh mavenCommand
                        echo 'å•å…ƒæµ‹è¯•å®Œæˆ'
                    } catch (Exception e) {
                        echo "æµ‹è¯•å¤±è´¥: ${e.getMessage()}"
                        currentBuild.result = 'UNSTABLE'
                    }
                }
            }
            post {
                always {
                    script {
                        // æ£€æŸ¥æµ‹è¯•æŠ¥å‘Šæ–‡ä»¶æ˜¯å¦å­˜åœ¨
                        def testReports = sh(
                            script: 'find target/surefire-reports -name "*.xml" 2>/dev/null || echo "none"',
                            returnStdout: true
                        ).trim()
                        
                        if (testReports != "none" && testReports != "") {
                            echo "å‘ç°æµ‹è¯•æŠ¥å‘Šï¼Œæ­£åœ¨å‘å¸ƒ..."
                            junit 'target/surefire-reports/*.xml'
                        } else {
                            echo 'æœªæ‰¾åˆ°æµ‹è¯•æŠ¥å‘Šæ–‡ä»¶'
                        }
                        
                        // æ£€æŸ¥è¦†ç›–ç‡æŠ¥å‘Š
                        def coverageReport = sh(
                            script: 'test -f target/site/jacoco/index.html && echo "exists" || echo "none"',
                            returnStdout: true
                        ).trim()
                        
                        if (coverageReport == "exists") {
                            publishHTML([
                                allowMissing: false,
                                alwaysLinkToLastBuild: true,
                                keepAll: true,
                                reportDir: 'target/site/jacoco',
                                reportFiles: 'index.html',
                                reportName: 'JaCoCo Coverage Report'
                            ])
                        } else {
                            echo 'æœªæ‰¾åˆ°è¦†ç›–ç‡æŠ¥å‘Š'
                        }
                    }
                }
                success {
                    echo 'âœ… æ‰€æœ‰æµ‹è¯•é€šè¿‡!'
                }
                unstable {
                    echo 'âš ï¸ éƒ¨åˆ†æµ‹è¯•å¤±è´¥ï¼Œä½†ç»§ç»­æ„å»º'
                }
                failure {
                    echo 'âŒ æµ‹è¯•å¤±è´¥!'
                }
            }
        }
        
        stage('Build') {
            when {
                not { 
                    equals expected: 'FAILURE', actual: currentBuild.result 
                }
            }
            steps {
                echo '=== æ„å»ºåº”ç”¨ ==='
                script {
                    try {
                        def buildCommand = '''
                            if command -v mvn &> /dev/null; then
                                echo "ä½¿ç”¨æœ¬åœ°Mavenæ„å»º..."
                                mvn clean package -DskipTests
                            else
                                echo "ä½¿ç”¨Dockerè¿è¡ŒMavenæ„å»º..."
                                docker run --rm -v "$PWD":/usr/src/app -v "$HOME/.m2":/root/.m2 -w /usr/src/app maven:3.9.4-openjdk-17 mvn clean package -DskipTests
                            fi
                        '''
                        sh buildCommand
                        echo 'åº”ç”¨æ„å»ºå®Œæˆ'
                        
                        // æ£€æŸ¥æ„å»ºäº§ç‰©
                        sh 'ls -la target/*.jar'
                    } catch (Exception e) {
                        echo "æ„å»ºå¤±è´¥: ${e.getMessage()}"
                        currentBuild.result = 'FAILURE'
                    }
                }
            }
        }
        
        stage('Build Docker Image') {
            when {
                not { 
                    equals expected: 'FAILURE', actual: currentBuild.result 
                }
            }
            steps {
                echo '=== æ„å»ºDockeré•œåƒ ==='
                script {
                    try {
                        // æ£€æŸ¥Dockeræ˜¯å¦å¯ç”¨
                        sh 'docker --version'
                        
                        // æ„å»ºDockeré•œåƒ
                        def image = docker.build("${DOCKER_IMAGE}:${DOCKER_TAG}")
                        
                        // æ ‡è®°latestç‰ˆæœ¬
                        sh "docker tag ${DOCKER_IMAGE}:${DOCKER_TAG} ${DOCKER_IMAGE}:latest"
                        
                        echo "Dockeré•œåƒæ„å»ºæˆåŠŸ: ${DOCKER_IMAGE}:${DOCKER_TAG}"
                        
                        // åˆ—å‡ºé•œåƒ
                        sh "docker images | grep ${DOCKER_IMAGE}"
                        
                        // å¦‚æœéœ€è¦æ¨é€åˆ°Registryï¼Œå–æ¶ˆä¸‹é¢çš„æ³¨é‡Š
                        /*
                        docker.withRegistry('https://registry.hub.docker.com', 'docker-hub-credentials') {
                            image.push()
                            image.push('latest')
                        }
                        */
                        
                    } catch (Exception e) {
                        echo "Dockeræ„å»ºå¤±è´¥: ${e.getMessage()}"
                        echo "å¯èƒ½åŸå› : Dockeræœªå®‰è£…æˆ–æƒé™ä¸è¶³"
                        currentBuild.result = 'UNSTABLE'
                    }
                }
            }
        }
        
        stage('Deploy to Kubernetes') {
            when {
                not { 
                    equals expected: 'FAILURE', actual: currentBuild.result 
                }
            }
            steps {
                echo '=== éƒ¨ç½²åˆ°Kubernetes ==='
                script {
                    try {
                        sh '''
                            echo "æ£€æŸ¥kubectlé…ç½®..."
                            kubectl version --client
                            
                            echo "æ£€æŸ¥Kubernetesè¿æ¥..."
                            kubectl get nodes || echo "æ— æ³•è¿æ¥åˆ°Kubernetesé›†ç¾¤"
                            
                            echo "æ›´æ–°éƒ¨ç½²æ–‡ä»¶ä¸­çš„é•œåƒæ ‡ç­¾..."
                            if [ -f k8s/deployment.yaml ]; then
                                sed -i "s|yys-app:latest|${DOCKER_IMAGE}:${DOCKER_TAG}|g" k8s/deployment.yaml
                                echo "é•œåƒæ ‡ç­¾å·²æ›´æ–°ä¸º: ${DOCKER_IMAGE}:${DOCKER_TAG}"
                            fi
                            
                            echo "åº”ç”¨Kubernetesé…ç½®..."
                            kubectl apply -f k8s/ || echo "Kuberneteséƒ¨ç½²å¤±è´¥ï¼Œå¯èƒ½æ˜¯é›†ç¾¤æœªé…ç½®"
                            
                            echo "åº”ç”¨HPAé…ç½®..."
                            kubectl apply -f hpa/ || echo "HPAéƒ¨ç½²å¤±è´¥"
                        '''
                    } catch (Exception e) {
                        echo "Kuberneteséƒ¨ç½²å¤±è´¥: ${e.getMessage()}"
                        echo "è¿™å¯èƒ½æ˜¯å› ä¸ºJenkinsç¯å¢ƒä¸­æœªé…ç½®kubectlæˆ–Kubernetesé›†ç¾¤è®¿é—®"
                        currentBuild.result = 'UNSTABLE'
                    }
                }
            }
        }
        
        stage('Verify Deployment') {
            when {
                not { 
                    equals expected: 'FAILURE', actual: currentBuild.result 
                }
            }
            steps {
                echo '=== éªŒè¯éƒ¨ç½² ==='
                script {
                    try {
                        sh '''
                            echo "æ£€æŸ¥éƒ¨ç½²çŠ¶æ€..."
                            kubectl get deployments -l app=yys-app || echo "æ— æ³•è·å–éƒ¨ç½²çŠ¶æ€"
                            
                            echo "æ£€æŸ¥PodçŠ¶æ€..."
                            kubectl get pods -l app=yys-app || echo "æ— æ³•è·å–PodçŠ¶æ€"
                            
                            echo "æ£€æŸ¥æœåŠ¡çŠ¶æ€..."
                            kubectl get services -l app=yys-app || echo "æ— æ³•è·å–æœåŠ¡çŠ¶æ€"
                            
                            echo "æ£€æŸ¥HPAçŠ¶æ€..."
                            kubectl get hpa || echo "æ— æ³•è·å–HPAçŠ¶æ€"
                            
                            echo "éƒ¨ç½²éªŒè¯å®Œæˆ"
                        '''
                    } catch (Exception e) {
                        echo "éƒ¨ç½²éªŒè¯å¤±è´¥: ${e.getMessage()}"
                        currentBuild.result = 'UNSTABLE'
                    }
                }
            }
        }
    }
    
    post {
        always {
            echo '=== æ¸…ç†å·¥ä½œç©ºé—´ ==='
            script {
                // æ¸…ç†Dockeré•œåƒï¼ˆå¯é€‰ï¼‰
                try {
                    sh "docker rmi ${DOCKER_IMAGE}:${DOCKER_TAG} || true"
                } catch (Exception e) {
                    echo "æ¸…ç†Dockeré•œåƒå¤±è´¥: ${e.getMessage()}"
                }
            }
            cleanWs()
        }
        success {
            echo 'ğŸ‰ Pipelineæ‰§è¡ŒæˆåŠŸ!'
            script {
                def summary = """
                âœ… æ„å»ºæˆåŠŸæ‘˜è¦:
                - æ„å»ºå·: ${BUILD_NUMBER}
                - é•œåƒ: ${DOCKER_IMAGE}:${DOCKER_TAG}
                - åˆ†æ”¯: ${env.BRANCH_NAME ?: 'main'}
                - æäº¤: ${env.GIT_COMMIT ?: 'unknown'}
                """
                echo summary
            }
        }
        unstable {
            echo 'âš ï¸ Pipelineå®Œæˆä½†æœ‰è­¦å‘Š - éƒ¨åˆ†æ­¥éª¤å¤±è´¥ä½†ä¸å½±å“ä¸»è¦åŠŸèƒ½'
        }
        failure {
            echo 'âŒ Pipelineæ‰§è¡Œå¤±è´¥!'
        }
    }
}
